#!/bin/bash

ASM_DIR="asm/non_matchings"
CONTEXT_DIR="contexts"
DATA_FILES="include/macros.inc data/data_0*.s data/data_1*.s data/data_credits*.s data/data_audio.s data/rodata_audio*.s"
#COMMON_CONTEXT="${CONTEXT_DIR}/common.c"
COMMON_CONTEXT="ctx.c"
CONTEXT_M2C_OPTS="--stack-structs --zfill-constants"
DISSASEMBLY_M2C_OPTS="--zfill-constants"
INCBIN_OPTS="--incbin-dir ./expected/build/us --incbin-dir ./"
DISSASEMBLY_FILE="FILE_NAME_HERE"

make_function_context () {
	echo "$(../mips_to_c/m2c.py \
		${ASM_DIR}/$1/$2.s \
		${DATA_FILES} \
		${CONTEXT_M2C_OPTS} \
		--context ${COMMON_CONTEXT})" > "${CONTEXT_DIR}/$1/$2.c" 2>&1
}

make_function_dissasembly () {
    echo "#ifdef MIPS_TO_C";
    echo "//generated by m2c commit 9841ff34ca242f5f14b2eab2b54a7a65ac47d80f on $(date +%b-%d-%Y)";
    ../mips_to_c/m2c.py \
    	${ASM_DIR}/$1/$2.s \
		${DATA_FILES} \
		${DISSASEMBLY_M2C_OPTS} \
	    --context ${COMMON_CONTEXT} --context ${CONTEXT_DIR}/$1/$2.c
    echo "#else";
    echo "GLOBAL_ASM(\"${ASM_DIR}/$1/$2.s\")";
    echo "#endif"
}

directory="$1"
function="$2"

if [[ ! -d "${CONTEXT_DIR}/${directory}" ]]; then
    mkdir -p "${CONTEXT_DIR}/${directory}"
fi

if [[ -f "${CONTEXT_DIR}/${directory}/${function}.c" ]]; then
	echo "$(make_function_dissasembly ${directory} ${function})" > "${DISSASEMBLY_FILE}" 2>&1
else
	make_function_context ${directory} ${function}
fi
